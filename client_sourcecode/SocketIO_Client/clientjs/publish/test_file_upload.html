<!DOCTYPE html>
<html>
  <head>
    <!-- <script type="text/javascript" src="config.js"></script> -->
    <script src="esas-admin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  </head>
  <body>
    <input id="upload_file" class="" type="file" multiple />
  </body>
</html>

<script>
  const axios = require('axios/dist/browser/axios.cjs');
  const files = []
  const upload = () => {
    return new Promise(async (resolve) => {
      const file = files.shift();
      try {
        const key = await post_data2(file);
        // const key = await esasClientV2.fileAnalyze(file);
        console.log("Success : ")
        console.log(key)
      } catch (e) {
        console.log("Error : ")
        console.log(e)
      }
    });
  };

  const runUpload = async () => {
    while(files.length > 0) {
      await upload();
    }
  };

  const drop = (event) => {
    const data = event.target;
    for (const file of data.files) {
      console.log(file)
      if (file.type.startsWith('audio/')) {
        files.push({
          file
        });
      }
    }

    event.stopPropagation();
    for (const file of files) {
      runUpload();
    }
  };

  async function post_data(file){
    const form = new FormData();
    form.append('uploadFile', file);
    fetch('https://ec2-122-248-205-250.ap-southeast-1.compute.amazonaws.com/uploadFile', {
    method: 'POST',
    headers: { 'Content-Type': 'multipart/form-data' },
    body: form
    })
      .then(response => response.json())
      .then(response => console.log(JSON.stringify(response)))
  }

  function post_data2(file){
    return new Promise(async (resolve, reject) => {
      const form = new FormData();
      form.append('uploadFile', file);
      try {
        const res = await fetch('http://ec2-122-248-205-250.ap-southeast-1.compute.amazonaws.com/uploadFile', {
                                mode: "no-cors",
                                method: 'POST',
                                headers: { 'Content-Type': 'multipart/form-data'},
                                body: form
                                })
        if (res.status != 200) {
          throw `Status: ${res.status}`
        }
        if (res.data.code != 0) {
          throw `code: ${res.data.code}, ${res.data.message}`;
        }
        resolve(res.data.key);
      } catch (e) {
        reject(e);
      }
    });
  }

  window.onload = () => {
    const inputFile = document.querySelector('#upload_file')
    inputFile.addEventListener('change', drop, false);
  }

  
</script>